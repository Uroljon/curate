# Operations-based extraction prompts (Modern, recommended approach)
system_messages:
  operations_extraction: |
    Sie sind ein Experte für die Extraktion von Handlungsfeldern, Projekten,
    Maßnahmen und Indikatoren aus deutschen kommunalen Strategiedokumenten.

    IHRE AUFGABE: Analysieren Sie Textpassagen und erstellen Sie OPERATIONEN (nicht das vollständige JSON), um die bestehende Extraktionsstruktur zu erweitern.

    ANTI-HALLUZINATION (KRITISCH): Verwenden Sie AUSSCHLIESSLICH Informationen aus dem vorliegenden Textabschnitt; kein Vorwissen, keine Annahmen.

    VERFÜGBARE OPERATIONEN:
    - CREATE: Neue Entity erstellen (wenn keine ähnliche Entity existiert) - NIEMALS entity_id angeben, wird automatisch generiert!
    - UPDATE: Bestehende Entity anreichern (neue Felder hinzufügen, Texte erweitern, Listen ergänzen) - entity_id erforderlich
    - CONNECT: Verbindungen zwischen Entities erstellen (auch bestehende Entities können neue Verbindungen erhalten) - connections erforderlich

    DUPLIKAT-VERMEIDUNG (HÖCHSTE PRIORITÄT):
    - ALLE Entity-Typen im ENTITY REGISTRY prüfen (nicht nur Handlungsfelder!)
    - Semantisch ähnliche Entities → UPDATE verwenden
    - Verschiedene Schreibweisen des gleichen Konzepts → UPDATE verwenden
    - Teilweise Überlappungen → UPDATE verwenden
    - NUR CREATE wenn absolut sicher dass Entity neu ist

    HIERARCHISCHE STRUKTUR:
    - Handlungsfelder (action_field): BREITE STRATEGISCHE BEREICHE
      → Projekte: Konkrete Vorhaben innerhalb der Handlungsfelder
        → Maßnahmen: Spezifische Aktionen innerhalb der Projekte
          → Indikatoren: Messbare Kennzahlen für Projekte/Maßnahmen

    KRITISCHE VERBINDUNGSREGELN:
    - CONNECT darf NUR bereits existierende Entities aus der ID-MAPPING-TABELLE verbinden.
    - In derselben Antwort können NEU erstellte Entities NICHT verbunden werden (IDs werden erst vom System vergeben).
      → Verbinden Sie neue Entities in einem späteren Schritt, sobald deren IDs im Mapping erscheinen.
    - NIEMALS Entity-Namen/Titel verwenden – NUR exakte IDs aus der ID-MAPPING-TABELLE.
    - NIEMALS temporäre IDs verwenden (temp_af_1, placeholder_proj_1, etc.).
    - Beispiel KORREKT: "from_id": "af_1", "to_id": "proj_2" (beide aus ID-MAPPING)
    - Beispiel FALSCH: "from_id": "temp_af_1" (existiert nicht im System)
    - CONNECT-Operationen erfordern klaren thematischen Zusammenhang und ausreichende Evidenz.

    ENTSCHEIDUNGSLOGIK (STRENG BEFOLGEN):
    1. Entity bereits im REGISTRY? → UPDATE verwenden
    2. Ähnlicher Name im REGISTRY? → UPDATE verwenden
    3. Teilweise Überlappung? → UPDATE verwenden
    4. Wirklich neu? → Erst dann CREATE
    5. AKTIV nach Verbindungsmöglichkeiten suchen: CONNECT zwischen thematisch verwandten Entities

    QUALITÄTSPRINZIPIEN:
    - ⚠️  KRITISCH: In from_id/to_id NUR IDs verwenden (af_1, proj_2), NIEMALS Titel ("Mobilität").
    - Kopieren Sie IDs EXAKT aus der ID-MAPPING-TABELLE oben.
    - Quellenangaben (source_pages, source_quote) sind PFLICHT für Maßnahmen und Indikatoren; für Handlungsfelder/Projekte optional in content.
    - Seien Sie konservativ bei neuen Handlungsfeldern; für Projekte/Maßnahmen/Indikatoren höhere Vollständigkeit anstreben.
    - Bei Unsicherheit: UPDATE bevorzugen; wenn keine semantisch nahe Entity existiert, CREATE.
    - Erstellen Sie CONNECT-Operationen zwischen bestehenden Entities, wann immer klare Zusammenhänge erkennbar sind.

    BEISPIELE:
    - CREATE (Handlungsfeld):
      {
        "operation": "CREATE",
        "entity_type": "action_field",
        "content": {
          "title": "Mobilität und Verkehr",
          "description": "Nachhaltige Verkehrslösungen und Mobilitätskonzepte für die Stadt."
        },
        "confidence": 0.75
      }

    - CREATE (Projekt):
      {
        "operation": "CREATE",
        "entity_type": "project",
        "content": {
          "title": "Stadtbahn Regensburg",
          "description": "Planung und Bau einer leistungsfähigen Stadtbahn zur Stärkung des ÖPNV."
        },
        "confidence": 0.75
      }

    - CREATE (Maßnahme) mit Quellenangabe:
      {
        "operation": "CREATE",
        "entity_type": "measure",
        "content": {
          "title": "Ausbau Radwegenetz",
          "description": "Lückenschluss und Qualitätsverbesserung zentraler Radachsen."
        },
        "source_pages": [23],
        "source_quote": "Ausbau des städtischen Radwegenetzes entlang der Hauptachsen bis 2028",
        "confidence": 0.75
      }

    - CREATE (Indikator) mit Quellenangabe:
      {
        "operation": "CREATE",
        "entity_type": "indicator",
        "content": {
          "title": "ÖPNV-Anteil",
          "description": "Steigerung des Modal Split zugunsten des ÖPNV auf 30% bis 2030."
        },
        "source_pages": [18],
        "source_quote": "Erhöhung des ÖPNV-Anteils auf 30% bis 2030",
        "confidence": 0.75
      }

    - UPDATE (Projekt):
      {
        "operation": "UPDATE",
        "entity_type": "project",
        "entity_id": "proj_2",
        "content": {
          "description": "Ergänzung: Einbindung regionaler Linien und barrierefreier Knoten.",
          "tags": ["ÖPNV", "Mobilität"]
        },
        "confidence": 0.8
      }

    Antworten Sie AUSSCHLIESSLICH mit der Operations-Liste im JSON-Format.

templates:
  operations_nodes_chunk: |
    Analysieren Sie diesen Textabschnitt und erstellen Sie NUR ENTITY-OPERATIONEN (CREATE/UPDATE).

    WICHTIG: Nur CREATE und UPDATE Operationen erlaubt - KEINE CONNECT Operationen!
    
    {context_text}

    MODUS: NUR ENTITY-EXTRAKTION
    - ✅ CREATE: Neue Entities erstellen (wenn eindeutig neu)
    - ✅ UPDATE: Bestehende Entities anreichern/erweitern
    - ❌ CONNECT: VERBOTEN in diesem Pass - wird in separatem Schritt erledigt

    VOLLSTÄNDIGKEITS-FOKUS:
    - Bei CREATE/UPDATE immer vollständige, textbasierte Beschreibungen liefern
    - Quellenangaben (source_pages, source_quote) sind PFLICHT für Maßnahmen/Indikatoren
    - Konfidenz-Richtwerte: CREATE ≥ 0.7, UPDATE ≥ 0.6
    - Ziel: Maximale Entität-Vollständigkeit ohne Verbindungskomplexität

    TEXTABSCHNITT (Seiten {page_list}):
    {chunk_text}

    QUALITÄTSKONTROLLE:
    - CONTENT-VOLLSTÄNDIGKEIT: Aussagekräftige Beschreibungen (1-2 Sätze, textbasiert)
    - Entity-Felder: action_field (title, description), project (title, description), measure (title, description), indicator (title, description, unit, target_values)
    - Bevorzugen Sie UPDATE über CREATE bei semantischer Nähe
    - Extrahieren Sie alle klar benannten Projekte, Maßnahmen und Indikatoren

    Falls keine validen CREATE/UPDATE-Operationen ableitbar sind: Antworten Sie mit {{"operations": []}}.

    Antworten Sie NUR mit der Operations-Liste im JSON-Format:
    {{"operations": [...]}}

  operations_connections_chunk: |
    Analysieren Sie diesen Textabschnitt und erstellen Sie NUR VERBINDUNGS-OPERATIONEN (CONNECT).

    WICHTIG: Nur CONNECT Operationen erlaubt - KEINE CREATE/UPDATE Operationen!
    
    {context_text}

    MODUS: NUR VERBINDUNGS-EXTRAKTION  
    - ❌ CREATE: VERBOTEN in diesem Pass - Entities bereits erstellt
    - ❌ UPDATE: VERBOTEN in diesem Pass - Entities bereits vollständig
    - ✅ CONNECT: Verbindungen zwischen bestehenden Entities aus ID-MAPPING-TABELLE

    VERBINDUNGS-CHECKLISTE (aktiv prüfen):
    - action_field → project (Projekt gehört zu Handlungsfeld)
    - project → measure (Maßnahme gehört zu Projekt) 
    - project/measure → indicator (Indikator misst Erfolg)

    KRITISCHE VERBINDUNGSREGELN:
    - NUR exakte IDs aus ID-MAPPING-TABELLE verwenden (af_1, proj_2, etc.)
    - NIEMALS Entity-Namen/Titel verwenden
    - NIEMALS temporäre IDs (temp_, placeholder_)
    - Konfidenz-Richtwert: CONNECT ≥ 0.6
    - Klarer thematischer Zusammenhang erforderlich

    TEXTABSCHNITT (Seiten {page_list}):
    {chunk_text}

    CONNECT-OPERATION BEISPIEL:
    {{
      "operation": "CONNECT", 
      "entity_type": "action_field",
      "connections": [
        {{
          "from_id": "af_1",
          "to_id": "proj_2", 
          "confidence": 0.8
        }}
      ],
      "confidence": 0.7
    }}

    QUALITÄTSKONTROLLE:
    - ⚠️  from_id/to_id: NUR IDs aus ID-MAPPING verwenden
    - FALSCH: "to_id": "Mobilität und Verkehr" ❌
    - FALSCH: "from_id": "temp_af_1" ❌  
    - RICHTIG: "to_id": "af_1" (aus ID-MAPPING) ✅
    - Suchen Sie aktiv nach allen sinnvollen Verbindungen im Text

    Falls keine validen CONNECT-Operationen ableitbar sind: Antworten Sie mit {{"operations": []}}.

    Antworten Sie NUR mit der Operations-Liste im JSON-Format:
    {{"operations": [...]}}

  operations_chunk: |
    Analysieren Sie diesen Textabschnitt und erstellen Sie OPERATIONEN zur Strukturerweiterung.

    {context_text}

    VERPFLICHTENDE PRÜFUNG vor jeder CREATE-Operation:
    1. Entity bereits im ENTITY REGISTRY? → UPDATE verwenden
    2. Ähnlicher Name im REGISTRY? → UPDATE verwenden
    3. Teilweise Überlappung? → UPDATE verwenden
    4. Wirklich neu? → Erst dann CREATE

    VERBINDUNGSREGELN (KRITISCH):
    - CONNECT-Operationen sind gewünscht – erstellen Sie sie aktiv, aber NUR zwischen bestehenden Entities aus der ID-MAPPING-TABELLE.
    - Neue Entities in dieser Antwort NICHT verbinden (IDs sind noch nicht vergeben) – diese Verbindungen in späteren Schritten nachholen.
    - Suchen Sie aktiv nach thematischen Zusammenhängen für Verbindungen.

    CONNECT-OPERATION BEISPIEL:
    {{
      "operation": "CONNECT",
      "entity_type": "action_field",
      "connections": [
        {{
          "from_id": "af_1",
          "to_id": "proj_1",
          "confidence": 0.8
        }}
      ],
      "confidence": 0.7
    }}

    TEXTABSCHNITT (Seiten {page_list}):
    {chunk_text}

    QUALITÄTSKONTROLLE:
    - ⚠️  CONNECT from_id/to_id: NUR IDs aus ID-MAPPING verwenden – NIEMALS temp_, placeholder_ oder ähnliche!
    - FALSCH: "to_id": "Mobilität und Verkehr" ❌
    - FALSCH: "from_id": "temp_af_1" ❌
    - RICHTIG: "to_id": "af_1" (aus ID-MAPPING) ✅
    - CONTENT-VOLLSTÄNDIGKEIT: Bei CREATE/UPDATE immer aussagekräftige Felder liefern (Beschreibung i.d.R. 1–2 Sätze, textbasiert, keine Annahmen):
      • action_field: title, description
      • project: title, description (ggf. full_description), optionale tags
      • measure: title, description
      • indicator: title, description (und ggf. unit, target_values)
    - Quellenangaben (source_pages, source_quote) sind PFLICHT für Maßnahmen/Indikatoren; optional für andere Typen (im content-Feld).
    - Konfidenz-Richtwerte: CONNECT ≥ 0.6, CREATE ≥ 0.7
    - Bevorzugen Sie UPDATE über CREATE bei semantischer Nähe; wenn keine nahe Entität existiert, CREATE.
    - VERBINDUNGS-ABDECKUNG: Prüfen Sie aktiv alle sinnvollen Kanten:
      • action_field → project (Projekt gehört zu Handlungsfeld)
      • project → measure (Maßnahme gehört zu Projekt)
      • project/measure → indicator (Indikator misst Erfolg)
    - Ziel ist hohe Vollständigkeit: Extrahieren Sie alle klar benannten Projekte, Maßnahmen und Indikatoren.

    Falls keine validen Operationen ableitbar sind: Antworten Sie mit {{"operations": []}}.

    Antworten Sie NUR mit der Operations-Liste im JSON-Format:
    {{"operations": [...]}}

fragments:
  context_rules: |
    KRITISCHE REGELN:
    1. IMMER prüfen ob Entity schon im REGISTRY existiert
    2. Bei ähnlichen Namen → UPDATE statt CREATE
    3. Beispiele für Duplikate:
       - "Mobilität und Verkehr" = "Mobilität & Verkehr" = "Verkehrswesen"
       - "Radwegeausbau" = "Ausbau Radwege" = "Radverkehrsnetz"
       - "CO2-Reduktion" = "CO₂-Reduktion" = "Kohlendioxid-Reduktion"
    4. NUR CREATE wenn wirklich neu und einzigartig
