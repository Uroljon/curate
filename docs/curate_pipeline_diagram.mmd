graph TB
    %% Upload Endpoint Flow
    subgraph Upload["/upload Endpoint"]
        A[PDF Upload] --> B[Generate Unique Filename]
        B --> C[Save PDF to Upload Folder]

        C --> D[Text Extraction with OCR Fallback]
        D --> D1[PyMuPDF Native Text Extraction]
        D --> D2[Pytesseract OCR for Scanned Pages]
        D1 --> E[Page-Aware Text List]
        D2 --> E

        E --> F[Text Cleaning & Processing]
        F --> F1[Clean Text]
        F --> F2[Identify Headers/Footers]
        F --> F3[Remove Structural Noise]

        F --> G[Save Page-Aware Text File]
        G --> G1[Format: _pages.txt]
        G --> G2[Page-by-Page Text Storage]
        G --> G3[Preserves Page Numbers]

        G --> K[Return Response]
        K --> K1[Pages Extracted Count]
        K --> K2[Extraction Metadata]
        K --> K3[Source ID for Next Step]
    end

    %% Extract Structure Endpoint Flow
    subgraph Extract["/extract_structure Endpoint"]
        L[Request with Source ID] --> M[Load Pages from File]
        M --> M1[Read _pages.txt]
        M --> M2[Parse Page Format]
        M --> M3[Extract Page-Aware Text]

        M --> N[Create LLM Chunks]
        N --> N1[Direct Page-Aware Chunking]
        N --> N2[15K-20K chars per chunk]
        N --> N3[Add Context Headers]

        N --> O[Structure Extraction Loop]
        O --> O1[Process Each Chunk Independently]
        O1 --> O2[Query Ollama with Structured Output]
        O2 --> O3[Extract Action Fields/Projects/Measures/Indicators]
        O3 --> O4[Accumulate Results]
        O4 --> O1

        O --> P[Aggregate Extraction Results]
        P --> P1[Merge Similar Action Fields]
        P --> P2[Deduplicate Projects]
        P --> P3[Combine Measures/Indicators]
        P --> P4[LLM-Based Aggregation]

        P --> Q[Source Attribution]
        Q --> Q1[Load Original Page Text]
        Q --> Q2[Find Quote Locations]
        Q --> Q3[Match to Specific Pages]
        Q --> Q4[Add Source References]

        Q --> R[Final Processing]
        R --> R1[Validate German Content]
        R --> R2[Calculate Statistics]

        R --> S[Return Structured Data]
        S --> S1[Action Fields with Projects]
        S --> S2[Measures and Indicators]
        S --> S3[Page-Level Source Attribution]
        S --> S4[Extraction Metadata]
    end

    %% File Storage
    subgraph FileStorage["File Storage"]
        FS[(Upload Folder)]
        FS --> FS1[Original PDFs]
        FS --> FS2[Page-Aware Text - _pages.txt]
        FS --> FS3[Page Metadata Preserved]
    end

    %% Ollama Integration
    subgraph Ollama["Ollama LLM Service"]
        LLM[qwen3:14b Model]
        LLM --> LLM1[Structured Output Mode]
        LLM --> LLM2[Pydantic Schema Validation]
        LLM --> LLM3[German Language Processing]
    end

    %% Connect the flows
    K --> L
    G -.-> FS
    M -.-> FS
    O2 -.-> LLM

    %% Styling
    classDef endpoint fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    classDef process fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef storage fill:#c8e6c9,stroke:#1b5e20,stroke-width:2px
    classDef external fill:#ffccbc,stroke:#bf360c,stroke-width:2px

    class A,L endpoint
    class FS storage
    class LLM external
    class B,C,D,E,F,G,K,M,N,O,P,Q,R,S process
