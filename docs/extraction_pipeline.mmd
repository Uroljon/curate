flowchart TD
    %% Upload Endpoint (Entry Point)
    subgraph Upload["/upload - Document Ingestion"]
        A["PDF Upload"]
        B["Text Extraction + OCR"]
        C["Page-Aware Text Processing"]
        D["Save: source_id_pages.txt"]
        E["Return Source ID"]
        
        A --> B
        B --> C
        C --> D
        D --> E
    end

    %% Initial Chunking (Only Truly Shared Step)
    subgraph InitialChunk["Initial Chunking (Shared)"]
        F["Load source_id_pages.txt"]
        G["Create 8K-12K char chunks with 10% overlap"]
        
        F --> G
    end

    %% Enhanced Extraction Pipeline
    subgraph Enhanced["/extract_enhanced Pipeline"]
        H1["extract_direct_to_enhanced()"]
        I1["create_simplified_system_message_with_context()"]
        J1["Prompts: 4-bucket JSON with accumulated context"]
        K1["LLM Query: EnrichedReviewJSON schema"]
        L1["Conservative entity resolution"]
        M1["Output: _enhanced_structure.json"]
        
        H1 --> I1
        I1 --> J1
        J1 --> K1
        K1 --> L1
        L1 --> M1
    end

    %% Operations Extraction Pipeline
    subgraph Operations["/extract_enhanced_operations Pipeline"]
        H2["extract_direct_to_enhanced_with_operations()"]
        I2["create_operations_system_message()"]
        J2["Prompts: CREATE/UPDATE/CONNECT operations"]
        K2["LLM Query: ExtractionOperations schema"]
        L2["OperationExecutor + Global registry"]
        M2["Output: _operations_result.json"]
        
        H2 --> I2
        I2 --> J2
        J2 --> K2
        K2 --> L2
        L2 --> M2
    end

    %% LLM Backend (Shared Infrastructure)
    subgraph LLM["Multi-Provider LLM Backend"]
        LLM1["Provider Abstraction"]
        LLM2["OpenRouter: o4-mini-high (Default)"]
        LLM3["Ollama: Local Models"]
        LLM4["vLLM: High Performance"]
        LLM5["OpenAI/Gemini: Direct APIs"]
        LLM6["200K+ Context, 65K Output, German Support"]
        
        LLM1 --> LLM2
        LLM1 --> LLM3
        LLM1 --> LLM4
        LLM1 --> LLM5
        LLM1 --> LLM6
    end

    %% File Storage
    subgraph Storage["File Storage (data/uploads/)"]
        N["source_id_pages.txt - Always created"]
        O["Dialog logs: .jsonl files"]
        P["Extraction results: .json files"]
    end

    %% Main Flow Connections
    E --> F
    G --> H1
    G --> H2
    
    K1 --> LLM1
    K2 --> LLM1
    
    %% File Storage Connections (dotted lines)
    D -.-> N
    M1 -.-> P
    M2 -.-> P
    J1 -.-> O
    J2 -.-> O

    %% Styling
    classDef upload fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef shared fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef enhanced fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef operations fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
    classDef llm fill:#ffccbc,stroke:#f57c00,stroke-width:2px
    classDef storage fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px

    class A,B,C,D,E upload
    class F,G shared
    class H1,I1,J1,K1,L1,M1 enhanced
    class H2,I2,J2,K2,L2,M2 operations
    class LLM1,LLM2,LLM3,LLM4,LLM5,LLM6 llm
    class N,O,P storage